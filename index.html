<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/styles.css" />
    <title>Pearson</title>
  </head>
  <body>
    <header>
      <div>
        <a
          class="header-logo"
          href="https://www.pearson.com/en-ca.html"
          target="blank"
          ><img
            src="https://spark.pearson.com/assets/logo.svg"
            class="header-logo"
            alt="Pearson logo"
        /></a>
      </div>
    </header>
    <section class="container select-classroom">
      <h2>Select Your Classroom</h2>
      <div class="classroom-selection-list">
        <!-- <div class="class-item-container">
          <div class="class-logo"></div>
          <div class="class-name">Susan's Class</div>
          <div class="class-btn">
            <button class="button edit">Edit</button>
          </div>
        </div> -->
      </div>
      <button class="button primary">Create Classroom</button>
    </section>
    <section class="container edit-classroom">
      <div class="class-logo edit"></div>
      <input
        type="text"
        class="text-input"
        id="class-name"
        placeholder="CLASS NAME"
      />
      <h2 class="edit-header">What is your class code?</h2>
      <h2 class="class-code-header"></h2>
      <input
        type="text"
        class="text-input"
        id="class-code"
        placeholder="YOUR CODE"
        maxlength="6"
      />
      <div class="btn-container">
        <button class="button cancel">Cancel</button>
        <button class="button save" disabled>Save</button>
      </div>
      <h3>Your class code is provided by your teacher</h3>
    </section>

    <script>
      const selectClassroomSection =
        document.querySelector(".select-classroom");
      const editClassroomSection = document.querySelector(".edit-classroom");
      const createButton = document.querySelector(".button.primary");
      const saveButton = document.querySelector(".button.save");
      const cancelButton = document.querySelector(".button.cancel");
      const classNameInput = document.getElementById("class-name");
      const classCodeInput = document.getElementById("class-code");

      // Array to store classrooms
      let classrooms = [];

      // Function to check if Save button should be enabled
      function validateInputs() {
        const className = classNameInput.value.trim();
        const classCode = classCodeInput.value.trim();

        saveButton.disabled = !(className && classCode.length === 6);
      }

      // Show edit classroom and hide select classroom
      function showEditClassroom() {
        selectClassroomSection.style.display = "none";
        editClassroomSection.style.display = "flex";
      }

      // Show select classroom and hide edit classroom
      function showSelectClassroom() {
        selectClassroomSection.style.display = "flex";
        editClassroomSection.style.display = "none";
      }

      // Transform class code to uppercase
      classCodeInput.addEventListener("input", function () {
        this.value = this.value.toUpperCase();
        validateInputs();
      });

      // Validate class name input
      classNameInput.addEventListener("input", validateInputs);

      // Event listeners
      createButton.addEventListener("click", showEditClassroom);
      cancelButton.addEventListener("click", showSelectClassroom);

      // Handle the Edit button functionality
      document.addEventListener("click", function (event) {
        if (event.target.classList.contains("edit")) {
          const classItem = event.target.closest(".class-item-container");
          const classCode = classItem.dataset.classCode;

          // Find the classroom in the array
          const classroom = classrooms.find(
            (cls) => cls.classCode === classCode
          );

          if (classroom) {
            // Populate the inputs with the selected class details
            classNameInput.value = classroom.className;
            classCodeInput.value = classroom.classCode;

            // Validate inputs to enable the Save button if conditions are met
            validateInputs();

            // Show the edit classroom section
            showEditClassroom();
          }
        }
      });

      saveButton.addEventListener("click", async function () {
        const className = classNameInput.value.trim();
        const classCode = classCodeInput.value.trim();

        if (className) {
          try {
            const response = await fetch(
              `https://spark2-stg.pearson.com/api/checkClassCode/${classCode}`
            );
            const isValidCode = await response.json();

            if (isValidCode) {
              // Check if the class already exists in the array
              const existingClassroomIndex = classrooms.findIndex(
                (cls) => cls.classCode === classCode
              );

              if (existingClassroomIndex !== -1) {
                // Update the existing classroom
                classrooms[existingClassroomIndex].className = className;
              } else {
                // Add the new classroom to the array
                classrooms.push({ className, classCode });
              }

              // Update the UI
              renderClassroomList();

              // Reset the form
              classNameInput.value = "";
              classCodeInput.value = "";
              saveButton.disabled = true;

              // Show select classroom and hide edit classroom
              showSelectClassroom();
            } else {
              alert("Wrong class code. Please try again.");
            }
          } catch (error) {
            console.error("Error:", error);
            alert("There was an error validating the class code.");
          }
        }
      });

      // Function to render the classroom list
      function renderClassroomList() {
        const classroomList = document.querySelector(
          ".classroom-selection-list"
        );
        classroomList.innerHTML = "";

        classrooms.forEach((classroom) => {
          const classItem = document.createElement("div");
          classItem.className = "class-item-container";
          classItem.dataset.classCode = classroom.classCode;
          classItem.innerHTML = `
            <div class="class-logo"></div>
            <div class="class-name">${classroom.className}</div>
            <div class="class-btn">
              <button class="button edit">Edit</button>
            </div>
          `;
          classroomList.appendChild(classItem);
        });
      }
    </script>
  </body>
</html>
